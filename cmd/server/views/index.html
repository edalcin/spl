<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Compras</title>
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <style>
        /* Ajustes Gerais */
        body > nav { padding: 0 1rem; border-bottom: 1px solid var(--muted-border); margin-bottom: 1rem; }
        .container { max-width: 800px; }

        /* Estilo dos Itens */
        .item-row {
            display: flex;
            align-items: center;
            padding: 0.8rem 0;
            border-bottom: 1px solid var(--muted-border);
        }
        .item-row button.delete-btn {
            margin-right: 1rem;
            margin-bottom: 0;
            padding: 0.2rem 0.6rem;
            width: auto;
            background: transparent;
            border: 1px solid var(--muted-border);
            color: var(--muted-color);
        }
        .item-row button.delete-btn:hover {
            border-color: var(--del-color);
            color: var(--del-color);
        }
        .item-name { flex-grow: 1; cursor: pointer; font-size: 1.1rem; }
        .item-edit-form { display: flex; gap: 0.5rem; flex-grow: 1; }
        .item-edit-form input { margin-bottom: 0; }
        .item-edit-form button { width: auto; margin-bottom: 0; padding: 0.2rem 0.5rem; }
        .forget-btn {
            background: none;
            border: 1px solid transparent;
            padding: 0 0.2rem;
            margin: 0;
            cursor: pointer;
            font-size: 0.7rem;
            line-height: 1;
            color: var(--muted-color);
            min-width: auto;
            width: auto;
            max-width: 1.5rem;
        }
        .forget-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Ajuste do Dropdown do Pico para mobile */
        details[role="list"] { margin-bottom: 0; }
        summary { margin-bottom: 0; white-space: nowrap; max-width: 200px; overflow: hidden; text-overflow: ellipsis; }

        /* Ajuste do bot√£o adicionar */
        .add-form { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; position: relative; flex-wrap: wrap; }
        .add-form input { margin-bottom: 0; }
        .add-form button { width: auto; margin-bottom: 0; }

        /* Custom autocomplete dropdown */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 60px;
            background: var(--card-background-color);
            border: 1px solid var(--muted-border);
            border-top: none;
            z-index: 100;
            max-height: 200px;
            overflow-y: auto;
        }
        .suggestions-dropdown:empty {
            display: none;
        }
        .suggestion-item {
            padding: 0.5rem 0.8rem;
            cursor: pointer;
            font-size: 1rem;
        }
        .suggestion-item:hover {
            background: var(--primary-focus);
        }
    </style>
</head>
<body>
    <!-- Navega√ß√£o Superior -->
    <nav>
        <ul>
            <li>
                <a href="/manage" class="contrast" style="font-weight: bold; text-decoration: none;">
                    ‚öôÔ∏è Minhas Listas
                </a>
            </li>
        </ul>
        <ul>
            <li>
                <!-- Dropdown de Sele√ß√£o de Lista -->
                {{ if not .ShowManager }}
                <details role="list" dir="rtl">
                    <summary aria-haspopup="listbox" role="button" class="outline">
                        {{ if .CurrentList.ID }}{{ .CurrentList.Name }}{{ else }}Selecionar...{{ end }}
                    </summary>
                    <ul role="listbox">
                        {{ range .Lists }}
                        <li><a href="/list/{{.ID}}">{{.Name}}</a></li>
                        {{ end }}
                        <li><hr></li>
                        <li><a href="/manage" style="color: var(--primary);">+ Criar Nova</a></li>
                    </ul>
                </details>
                {{ end }}
            </li>
        </ul>
    </nav>

    <main class="container">
        <!-- Conte√∫do Principal -->
        <section>
            {{ if .ShowManager }}
                <!-- Tela de Gest√£o de Listas -->
                <hgroup>
                    <h1>Gerenciar Listas</h1>
                    <h2>Crie, renomeie ou exclua suas listas</h2>
                </hgroup>

                <!-- Criar Nova Lista -->
                <article>
                    <form action="/lists/add" method="POST">
                        <label for="new-list"><strong>Criar Nova Lista</strong></label>
                        <div class="add-form">
                            <input type="text" id="new-list" name="name" placeholder="Ex: Mercado, Farm√°cia..." required>
                            <button type="submit">Criar</button>
                        </div>
                    </form>
                </article>

                <!-- Tabela de Listas -->
                <table role="grid">
                    <thead>
                        <tr>
                            <th>Nome da Lista</th>
                            <th style="width: 100px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range .Lists }}
                        <tr>
                            <td>
                                <form action="/lists/edit/{{.ID}}" method="POST" style="margin-bottom: 0;">
                                    <div style="display: flex; gap: 0.5rem;">
                                        <input type="text" name="name" value="{{.Name}}" required style="margin-bottom: 0;">
                                        <button type="submit" class="outline secondary" style="margin-bottom: 0; width: auto; padding: 0.2rem 0.5rem;">üíæ</button>
                                    </div>
                                </form>
                            </td>
                            <td>
                                <form action="/lists/delete/{{.ID}}" method="POST" style="margin-bottom: 0;" onsubmit="return confirm('Apagar lista {{.Name}}?');">
                                    <button type="submit" class="outline contrast" style="margin-bottom: 0; padding: 0.2rem 0.5rem; width: 100%;">üóëÔ∏è</button>
                                </form>
                            </td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>

                <p style="margin-top: 2rem; text-align: center;">
                    <a href="/">Voltar para as listas</a>
                </p>

            {{ else }}
                <!-- Tela da Lista de Compras Atual -->
                {{ if .CurrentList.ID }}
                    <!-- Formul√°rio de Adicionar Item -->
                    <form hx-post="/items/add" hx-target="#items-container" hx-on::after-request="this.reset(); document.getElementById('suggestions-dropdown').innerHTML='';">
                        <input type="hidden" name="list_id" value="{{ .CurrentList.ID }}">
                        <div class="add-form">
                            <input type="text" name="name" placeholder="Adicionar item..." required autofocus
                                   autocomplete="off"
                                   hx-get="/items/suggest"
                                   hx-trigger="input changed delay:200ms, focus"
                                   hx-target="#suggestions-dropdown"
                                   hx-include="closest form">
                            <button type="submit">+</button>
                            <div id="suggestions-dropdown" class="suggestions-dropdown"></div>
                        </div>
                    </form>

                    <!-- Lista de Itens -->
                    <div id="items-container">
                        {{ template "items-partial" . }}
                    </div>
                {{ else }}
                    <article style="text-align: center;">
                        <h3>Nenhuma lista selecionada</h3>
                        <p>Use o menu acima para selecionar ou criar uma lista.</p>
                    </article>
                {{ end }}
            {{ end }}
        </section>
    </main>

    <!-- Template Parcial de Itens -->
    {{ define "items-partial" }}
        {{ range .Items }}
        <div class="item-row" id="item-{{ .ID }}">
            <!-- Bot√£o de Deletar -->
            <button class="delete-btn"
                    hx-delete="/items/delete/{{ .ID }}"
                    hx-target="#items-container">
                ‚úï
            </button>

            <!-- Nome do Item (Clique para Editar) -->
            <span class="item-name"
                  onclick="this.style.display='none'; this.parentElement.querySelector('.forget-btn').style.display='none'; document.getElementById('edit-form-{{ .ID }}').style.display='flex';">
                {{ .Name }}
            </span>

            <!-- Bot√£o Esquecer (remove do autocomplete) -->
            <button class="forget-btn"
                    hx-post="/items/forget/{{ .ID }}"
                    hx-target="#items-container"
                    title="Esquecer (remover do auto-preenchimento)">
                üö´
            </button>

            <!-- Formul√°rio de Edi√ß√£o (Inicialmente Escondido) -->
            <form class="item-edit-form"
                  id="edit-form-{{ .ID }}"
                  style="display: none;"
                  hx-post="/items/edit/{{ .ID }}"
                  hx-target="#items-container">
                <input type="text" name="name" value="{{ .Name }}" required>
                <button type="submit" class="outline secondary">üíæ</button>
                <button type="button" class="outline contrast"
                        onclick="this.parentElement.style.display='none'; document.getElementById('item-{{ .ID }}').querySelector('.item-name').style.display='block'; document.getElementById('item-{{ .ID }}').querySelector('.forget-btn').style.display='block';">
                    ‚úï
                </button>
            </form>
        </div>
        {{ else }}
        <p style="text-align: center; color: #888; margin-top: 2rem;">Lista vazia! üéâ</p>
        {{ end }}
    {{ end }}
    <script>
    function selectSuggestion(el) {
        var input = document.querySelector('.add-form input[name="name"]');
        input.value = el.textContent;
        document.getElementById('suggestions-dropdown').innerHTML = '';
        input.focus();
    }
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.add-form')) {
            var dd = document.getElementById('suggestions-dropdown');
            if (dd) dd.innerHTML = '';
        }
    });
    </script>
</body>
</html>
